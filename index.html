<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KittenStore</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="styling.css">
  <script>
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(() => console.log("Service Worker Registered"))
        .catch(e => console.log(e));
    }
  </script>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/CodingKitten-YT/KittenStore/main/250icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/onsenui/js/onsenui.min.js"></script>
</head>
<body>
  <ons-navigator id="appNavigator" swipeable swipe-target-width="80px">
    <ons-page>
      <ons-splitter id="appSplitter">
        <ons-splitter-content page="tabbar.html"></ons-splitter-content>
      </ons-splitter>
    </ons-page>
  </ons-navigator>

  <template id="tabbar.html">
    <ons-page id="tabbar-page">
      <ons-toolbar>
        <div class="center">Home</div>
      </ons-toolbar>
      <ons-tabbar swipeable id="appTabbar" position="auto">
        <ons-tab label="Home" icon="md-home" page="home.html" active></ons-tab>
        <ons-tab label="Info" icon="md-info" page="info.html"></ons-tab>
        <ons-tab label="Settings" icon="md-settings" page="settings.html"></ons-tab>
      </ons-tabbar>
      <script>
        ons.getScriptPage().addEventListener('prechange', function(event) {
          if (event.target.matches('#appTabbar')) {
            event.currentTarget.querySelector('ons-toolbar .center').innerHTML = event.tabItem.getAttribute('label');
          }
        });
      </script>
    </ons-page>
  </template>

  <template id="home.html">
    <ons-page>
      <div class="search-bar-wrapper">
        <ons-search-input id="searchInput" placeholder="Search apps..." aria-label="Search apps" autocapitalize="off" autocorrect="off"></ons-search-input>
      </div>
      <div id="app-list" class="app-list"></div>
      <script>
        document.addEventListener('init', function() {
          fetchApps();
        });
        async function fetchApps() {
          try {
            const response = await fetch('https://raw.githubusercontent.com/swaggyP36000/TrollStore-IPAs/main/apps.json');
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            const data = await response.json();
            const appList = document.getElementById('app-list');
            appList.innerHTML = '';
            window.apps = data.apps;
            renderApps(window.apps);
            document.getElementById('searchInput').addEventListener('input', function(event) {
              const query = event.target.value.toLowerCase();
              const filteredApps = window.apps.filter(app => app.name.toLowerCase().includes(query));
              renderApps(filteredApps);
            });
          } catch (error) {
            console.error('Error fetching app data:', error);
            const appList = document.getElementById('app-list');
            appList.innerHTML = '<p>Failed to load apps. Please try again later.</p>';
          }
        }
        function renderApps(apps) {
          const appList = document.getElementById('app-list');
          appList.innerHTML = '';
          apps.forEach(app => {
            const latestVersion = app.versions[0];
            const cardHtml = `
              <ons-card class="app-card">
                <div class="app-content">
                  <div class="app-icon">
                    <img src="${app.iconURL}" alt="${app.name} Icon" 
                    onerror="this.onerror=null; this.src='https://placehold.co/400x400/000000/FFFFFF/png?text=No%5CnIcon&font=roboto';">
                  </div>
                  <div class="app-details">
                    <div class="app-title">${truncateTitle(app.name)}</div>
                    <div class="app-version">v${latestVersion.version}</div>
                  </div>
                </div>
                <div class="install-button-wrapper">
                  <ons-button class="install-button" id="push-button" onclick="showInstallOptions('${app.name}')" aria-label="Install ${app.name}">Install</ons-button>
                </div>
              </ons-card>
            `;
            appList.insertAdjacentHTML('beforeend', cardHtml);
          });
        }
        function truncateTitle(title) {
          return title.length > 17 ? title.substring(0, 17) + '...' : title;
        }
        function showInstallOptions(appName) {
          document.querySelector('#appNavigator').pushPage('page2.html', {
            data: { appName }
          });
        }
      </script>
    </ons-page>
  </template>

  <template id="info.html">
    <ons-page>
      <div class="credits-header">
        <p class="intro">Trouble shooting:</p>
      </div>
      <p class="limited-width">Please ensure you have URL Scheme enabled when trying to install apps with trollstore. It is under the security section in your trollstore app.</p>
      <img src="https://raw.githubusercontent.com/CodingKitten-YT/KittenStore/main/IMG_0006.jpeg" alt="Screenshot" class="centered-image">
      <br>
      <div class="credits-header">
        <p class="intro">Resources used for this project:</p>
      </div>
      <div class="credits-list">
        <ons-card class="credit-card" onclick="location.href='https://onsen.io';">
          <div class="card-content">
            <div class="card-title">Onsen UI</div>
            <div class="card-description">The most beautiful and efficient way to develop HTML5 hybrid and mobile web apps.</div>
          </div>
        </ons-card>
        <ons-card class="credit-card" onclick="location.href='https://github.com/swaggyP36000/TrollStore-IPAs';">
          <div class="card-content">
            <div class="card-title">Trollstore IPA's</div>
            <div class="card-description">A collection from many different sources, for TrollStore!</div>
          </div>
        </ons-card>
        <div class="credits-header">
          <p class="intro">Disclaimer:</p>
        </div>
        <p class="limited-width">I did not make any of these apps and i am not responsible for any use of them. I do not host any of these ipa files, this project is just for displaying them kinda like a search engine. I do not endorce piracy. If you have any complaints please contact me on discord: codingkitten</p>
        <div class="credits-header">
          <p class="intro">Emoji Guide for App Selection (Status):</p>
        </div>
        <p class="limited-width">
          ‚úÖ Indicates that an app is working or up-to-date.<br>
          ‚ùå Indicates that an app is either discontinued or not working.<br>
          ‚ö†Ô∏è Indicates that an app is outdated but still functional.<br>
          ‚ùî Indicates that the app's original source is inaccessible or has not been tested and its functionality is uncertain.<br>
          üëç Indicates that an app or tweak is considered better than another one from the repo. (Example: Paperback > Aidoku)<br>
          ‚≠ê Indicates that an app fully supports Widgets.<br>
          üí° Indicates that an app contains a hand-made tutorial. (Linked in its description)<br>
        </p>
        <p class="limited-width">These emojis should assist you in making informed decisions when selecting apps or tweaks from this repository. Please consider the provided emoji guidance when choosing the right application for your needs.</p>
      </div>
      <p class="limited-width">V1.04</p>
    </ons-page>
  </template>

  <!-- App detail page template -->
  <template id="page2.html">
    <ons-page id="page2">
      <ons-toolbar>
        <div class="left"><ons-back-button>Back</ons-back-button></div>
        <div class="center">{{ appName }}</div>
      </ons-toolbar>
  
      <div class="app-details-page">
        <img class="app-icon-large" src="" alt="{{ appName }} Icon">
  
        <div class="app-description"></div>
  
        <div class="app-size"></div>
  
        <div class="install-buttons">
          <ons-button id="trollstore-install" aria-label="Install with TrollStore">Install with TrollStore</ons-button>
          <ons-button id="sidestore-install" aria-label="Install with SideStore">Install with SideStore</ons-button>
          <ons-button id="appdb-search" aria-label="Search on AppDB">Search on AppDB</ons-button>
          <ons-button id="ipa-download" aria-label="Download IPA">Download IPA</ons-button>
        </div>
      </div>
  
      <script>
        document.addEventListener('init', async function(event) {
          const page = event.target;
  
          if (page.id === 'page2') {
              const { appName } = page.data;
  
              try {
                  const app = await fetchAppByName(appName);
                  const latestVersion = app.versions[0];
  
                  page.querySelector('.center').innerText = app.name;
  
                  const appIconElement = page.querySelector('.app-icon-large');
                  appIconElement.src = app.iconURL;
                  appIconElement.onerror = function() {
                      this.src = 'https://placehold.co/400x400/000000/FFFFFF/png?text=No%5CnIcon&font=roboto';
                  };
  
                  const cleanedDescription = latestVersion.localizedDescription.replace(/\nLast updated:.*$/m, '').replace(/Status:.*$/m, '');
  
                  const lastUpdatedDate = new Date(latestVersion.date);
                  const currentDate = new Date();
                  const diffTime = Math.abs(currentDate - lastUpdatedDate);
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
                  const updatedDescription = `${cleanedDescription}\nLast updated: ${diffDays} days ago`;
                  page.querySelector('.app-description').innerText = updatedDescription;
  
                  const statusMatch = latestVersion.localizedDescription.match(/Status:\s*(.*)/);
                  const statusEmojis = statusMatch ? statusMatch[1] : '';
  
                  const statusElement = document.createElement('div');
                  statusElement.className = 'app-status';
                  statusElement.innerText = statusEmojis;
                  page.querySelector('.app-description').appendChild(statusElement);
  
                  const fileSize = formatFileSize(latestVersion.size);
                  page.querySelector('.app-size').innerText = `File Size: ${fileSize}`;
  
                  page.querySelector('#trollstore-install').onclick = function() {
                      const trollStoreURL = `apple-magnifier://install?url=${encodeURIComponent(latestVersion.downloadURL)}`;
                      location.href = trollStoreURL;
                  };
  
                  page.querySelector('#sidestore-install').onclick = function() {
                      const sideStoreURL = `sidestore://source?url=${encodeURIComponent(latestVersion.downloadURL)}`;
                      location.href = sideStoreURL;
                  };
  
                  page.querySelector('#appdb-search').onclick = function() {
                      const appdbURL = `https://appdb.to/?name=${encodeURIComponent(app.name)}`;
                      window.open(appdbURL, '_blank');
                  };
  
                  page.querySelector('#ipa-download').onclick = function() {
                      window.open(latestVersion.downloadURL, '_blank');
                  };
  
                  updateInstallButtons();
  
              } catch (error) {
                  console.error('Error fetching app details:', error);
                  page.querySelector('.app-description').innerText = 'Failed to load app details.';
              }
          }
      });
  
      async function fetchAppByName(appName) {
          const response = await fetch('https://raw.githubusercontent.com/swaggyP36000/TrollStore-IPAs/main/apps.json');
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          const data = await response.json();
          return data.apps.find(app => app.name === appName);
      }
  
      function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
  
      function updateInstallButtons() {
        const showTrollStore = localStorage.getItem('showTrollStore') !== 'false';
        const showSideStore = localStorage.getItem('showSideStore') !== 'false';
        const showAppDB = localStorage.getItem('showAppDB') !== 'false';
  
        const trollstoreButton = document.getElementById('trollstore-install');
        const sidestoreButton = document.getElementById('sidestore-install');
        const appdbButton = document.getElementById('appdb-search');
  
        if (trollstoreButton) trollstoreButton.style.display = showTrollStore ? 'inline-block' : 'none';
        if (sidestoreButton) sidestoreButton.style.display = showSideStore ? 'inline-block' : 'none';
        if (appdbButton) appdbButton.style.display = showAppDB ? 'inline-block' : 'none';
      }
      </script>
    </ons-page>
  </template>

  <template id="settings.html">
    <ons-page id="settings-page">
      <div style="padding: 20px;">
        <ons-list>
          <ons-list-item>
            <div class="center">
              <span class="list-item__title">Show TrollStore Button</span>
            </div>
            <div class="right">
              <ons-switch id="trollstore-switch"></ons-switch>
            </div>
          </ons-list-item>
          <ons-list-item>
            <div class="center">
              <span class="list-item__title">Show SideStore Button</span>
            </div>
            <div class="right">
              <ons-switch id="sidestore-switch"></ons-switch>
            </div>
          </ons-list-item>
          <ons-list-item>
            <div class="center">
              <span class="list-item__title">Show AppDB Button</span>
            </div>
            <div class="right">
              <ons-switch id="appdb-switch"></ons-switch>
            </div>
          </ons-list-item>
        </ons-list>
      </div>
      <script>
        function updateInstallButtons() {
          const showTrollStore = localStorage.getItem('showTrollStore') !== 'false';
          const showSideStore = localStorage.getItem('showSideStore') !== 'false';
          const showAppDB = localStorage.getItem('showAppDB') !== 'false';

          const trollstoreButton = document.getElementById('trollstore-install');
          const sidestoreButton = document.getElementById('sidestore-install');
          const appdbButton = document.getElementById('appdb-search');

          if (trollstoreButton) trollstoreButton.style.display = showTrollStore ? 'inline-block' : 'none';
          if (sidestoreButton) sidestoreButton.style.display = showSideStore ? 'inline-block' : 'none';
          if (appdbButton) appdbButton.style.display = showAppDB ? 'inline-block' : 'none';
        }

        document.addEventListener('init', function(event) {
          const page = event.target;
          if (page.id === 'settings-page') {
            const trollstoreSwitch = document.getElementById('trollstore-switch');
            const sidestoreSwitch = document.getElementById('sidestore-switch');
            const appdbSwitch = document.getElementById('appdb-switch');

            trollstoreSwitch.checked = localStorage.getItem('showTrollStore') !== 'false';
            sidestoreSwitch.checked = localStorage.getItem('showSideStore') !== 'false';
            appdbSwitch.checked = localStorage.getItem('showAppDB') !== 'false';

            trollstoreSwitch.addEventListener('change', function() {
              localStorage.setItem('showTrollStore', this.checked);
              updateInstallButtons();
            });
            sidestoreSwitch.addEventListener('change', function() {
              localStorage.setItem('showSideStore', this.checked);
              updateInstallButtons();
            });
            appdbSwitch.addEventListener('change', function() {
              localStorage.setItem('showAppDB', this.checked);
              updateInstallButtons();
            });
          } else if (page.id === 'page2') {
            updateInstallButtons();
          }
        });

        document.addEventListener('DOMContentLoaded', function() {
          updateInstallButtons();
        });
      </script>
    </ons-page>
  </template>
</body>
</html>
