<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KittenStore</title>
  <!-- Onsen UI Stylesheet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/onsenui/css/onsen-css-components.css">
  <!-- Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <!-- External Stylesheet -->
  <link rel="stylesheet" href="styling.css">
  <script>
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(() => console.log("Service Worker Registered"))
        .catch(e => console.log(e));
    }
  </script>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/CodingKitten-YT/KittenStore/main/250icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/onsenui/js/onsenui.min.js"></script>
</head>
<body>
  <!-- Navigator to handle page transitions -->
  <ons-navigator id="appNavigator" swipeable swipe-target-width="80px">
    <ons-page>
      <ons-splitter id="appSplitter">
        <ons-splitter-content page="tabbar.html"></ons-splitter-content>
      </ons-splitter>
    </ons-page>
  </ons-navigator>

  <!-- Tab bar template -->
  <template id="tabbar.html">
    <ons-page id="tabbar-page">
      <ons-toolbar>
        <div class="center">Home</div>
      </ons-toolbar>
      <ons-tabbar swipeable id="appTabbar" position="auto">
        <ons-tab label="Home" icon="md-home" page="home.html" active></ons-tab>
        <ons-tab label="Info" icon="md-info" page="info.html"></ons-tab>
      </ons-tabbar>

      <script>
        // Update the toolbar title based on the selected tab
        ons.getScriptPage().addEventListener('prechange', function(event) {
          if (event.target.matches('#appTabbar')) {
            event.currentTarget.querySelector('ons-toolbar .center').innerHTML = event.tabItem.getAttribute('label');
          }
        });
      </script>
    </ons-page>
  </template>

  <!-- Home page template -->
  <template id="home.html">
    <ons-page>
      <div class="search-bar-wrapper">
        <ons-search-input id="searchInput" placeholder="Search apps..." aria-label="Search apps"></ons-search-input>
      </div>
  
      <div id="app-list" class="app-list"></div>
  
      <script>
        document.addEventListener('init', function() {
          fetchApps();
        });
  
        async function fetchApps() {
          try {
            const response = await fetch('https://raw.githubusercontent.com/swaggyP36000/TrollStore-IPAs/main/apps.json');
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            const data = await response.json();
  
            const appList = document.getElementById('app-list');
            appList.innerHTML = '';
  
            window.apps = data.apps;
  
            renderApps(window.apps);
  
            document.getElementById('searchInput').addEventListener('input', function(event) {
              const query = event.target.value.toLowerCase();
              const filteredApps = window.apps.filter(app => app.name.toLowerCase().includes(query));
              renderApps(filteredApps);
            });
          } catch (error) {
            console.error('Error fetching app data:', error);
            const appList = document.getElementById('app-list');
            appList.innerHTML = '<p>Failed to load apps. Please try again later.</p>';
          }
        }
  
        function renderApps(apps) {
          const appList = document.getElementById('app-list');
          appList.innerHTML = '';
  
          apps.forEach(app => {
            const latestVersion = app.versions[0];

            const cardHtml = `
              <ons-card class="app-card">
                <div class="app-content">
                  <div class="app-icon">
                    <img src="${app.iconURL}" alt="${app.name} Icon" 
                    onerror="this.onerror=null; this.src='https://placehold.co/400x400/000000/FFFFFF/png?text=No%5CnIcon&font=roboto';">
                  </div>
                  <div class="app-details">
                    <div class="app-title">${truncateTitle(app.name)}</div>
                    <div class="app-version">v${latestVersion.version}</div>
                  </div>
                </div>
                <div class="install-button-wrapper">
                  <ons-button class="install-button" id="push-button" onclick="showInstallOptions('${app.name}')" aria-label="Install ${app.name}">Install</ons-button>
                </div>
              </ons-card>
            `;

            appList.insertAdjacentHTML('beforeend', cardHtml);
          });
        }
  
        function truncateTitle(title) {
          return title.length > 17 ? title.substring(0, 17) + '...' : title;
        }
  
        function showInstallOptions(appName) {
          document.querySelector('#appNavigator').pushPage('page2.html', {
            data: { appName }
          });
        }
      </script>
    </ons-page>
  </template>

  <!-- Info page template -->
  <template id="info.html">
    <ons-page>
      <div class="credits-header">
        <p class="intro">Trouble shooting:</p>
      </div>
      
      <p class="limited-width">Please ensure you have URL Scheme enabled when trying to install apps with trollstore. It is under the security section in your trollstore app.</p>
      <img src="https://raw.githubusercontent.com/CodingKitten-YT/KittenStore/main/IMG_0006.jpeg" alt="Screenshot" class="centered-image">
      <br>
      <div class="credits-header">
        <p class="intro">Resources used for this project:</p>
      </div>
  
      <div class="credits-list">
        <ons-card class="credit-card" onclick="location.href='https://onsen.io';">
          <div class="card-content">
            <div class="card-title">Onsen UI</div>
            <div class="card-description">The most beautiful and efficient way to develop HTML5 hybrid and mobile web apps.</div>
          </div>
        </ons-card>
  
        <ons-card class="credit-card" onclick="location.href='https://github.com/swaggyP36000/TrollStore-IPAs';">
          <div class="card-content">
            <div class="card-title">Trollstore IPA's</div>
            <div class="card-description">A collection from many different sources, for TrollStore!</div>
          </div>
        </ons-card>
  
        <div class="credits-header">
          <p class="intro">Disclaimer:</p>
        </div>
        <p class="limited-width">I did not make any of these apps and i am not responsible for any use of them. I do not host any of these ipa files, this project is just for displaying them kinda like a search engine. I do not endorce piracy. If you have any complaints please contact me on discord: codingkitten</p>
  
        <div class="credits-header">
          <p class="intro">Emoji Guide for App Selection (Status):</p>
        </div>
        <p class="limited-width">
          ‚úÖ Indicates that an app is working or up-to-date.<br>
          ‚ùå Indicates that an app is either discontinued or not working.<br>
          ‚ö†Ô∏è Indicates that an app is outdated but still functional.<br>
          ‚ùî Indicates that the app's original source is inaccessible or has not been tested and its functionality is uncertain.<br>
          üëç Indicates that an app or tweak is considered better than another one from the repo. (Example: Paperback > Aidoku)<br>
          ‚≠ê Indicates that an app fully supports Widgets.<br>
          üí° Indicates that an app contains a hand-made tutorial. (Linked in its description)<br>
        </p>
        <p class="limited-width">These emojis should assist you in making informed decisions when selecting apps or tweaks from this repository. Please consider the provided emoji guidance when choosing the right application for your needs.</p>
      </div>
  
      <p class="limited-width">V1.02</p>
    </ons-page>
  </template>

  <!-- App detail page template -->
  <template id="page2.html">
    <ons-page id="page2">
      <ons-toolbar>
        <div class="left"><ons-back-button>Back</ons-back-button></div>
        <div class="center">{{ appName }}</div>
      </ons-toolbar>
  
      <div class="app-details-page">
        <img class="app-icon-large" src="" alt="{{ appName }} Icon">
  
        <div class="app-description"></div>
  
        <div class="app-size"></div>
  
        <div class="install-buttons">
          <ons-button id="trollstore-install" aria-label="Install with TrollStore">Install with TrollStore</ons-button>
          <ons-button id="ipa-download" aria-label="Download IPA">Download IPA</ons-button>
        </div>
      </div>
  
      <script>
        document.addEventListener('init', async function(event) {
          const page = event.target;
  
          if (page.id === 'page2') {
            const { appName } = page.data;
  
            // Fetch the app data based on the appName
            const app = await fetchAppByName(appName);
            const latestVersion = app.versions[0];
  
            page.querySelector('.center').innerText = app.name;
            page.querySelector('.app-icon-large').src = app.iconURL;
  
            // Remove the specific part from the localizedDescription
            const cleanedDescription = latestVersion.localizedDescription.replace(/\nLast updated:.*$/m, '').replace(/Status:.*$/m, '');
  
            // Calculate the last updated date
            const lastUpdatedDate = new Date(latestVersion.date);
            const currentDate = new Date();
            const diffTime = Math.abs(currentDate - lastUpdatedDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
            // Update the localizedDescription with the last updated date
            const updatedDescription = `${cleanedDescription}\nLast updated: ${diffDays} days ago`;
            page.querySelector('.app-description').innerText = updatedDescription;
  
            // Append the status separately
            const statusElement = document.createElement('div');
            statusElement.className = 'app-status';
            statusElement.innerText = 'Status: ‚úÖ üëç';
            page.querySelector('.app-description').appendChild(statusElement);
  
            // Display the file size
            const fileSize = formatFileSize(latestVersion.size);
            page.querySelector('.app-size').innerText = `File Size: ${fileSize}`;
  
            page.querySelector('#trollstore-install').onclick = function() {
              const trollStoreURL = `apple-magnifier://install?url=${encodeURIComponent(latestVersion.downloadURL)}`;
              location.href = trollStoreURL;
            };
  
            page.querySelector('#ipa-download').onclick = function() {
              window.open(latestVersion.downloadURL, '_blank');
            };
          }
        });
  
        async function fetchAppByName(appName) {
          const response = await fetch('https://raw.githubusercontent.com/swaggyP36000/TrollStore-IPAs/main/apps.json');
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const data = await response.json();
          return data.apps.find(app => app.name === appName);
        }
  
        function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
      </script>
    </ons-page>
  </template>
  <!-- Onsen UI Script -->
  <script src="https://cdn.jsdelivr.net/npm/onsenui/js/onsenui.min.js"></script>
</body>
</html>
